  
def APP_NAME= 'dental-search-controller'
try {
   timeout(time: 20, unit: 'MINUTES') {
      def appName="${APP_NAME}"
      def project=""
      node {
        stage("Initialize") {
          project = env.PROJECT_NAME
        }
      }
      node {
        stage("Building Image") {
        sh "oc start-build ${appName} --from-file=https://github.com/belayaperumal/dental-search/blob/master/openshift-pipeline.yaml -n ${project}"
          timeout(time: 20, unit: 'MINUTES') {
            openshift.withCluster() {
              openshift.withProject() {
                def bc = openshift.selector('bc', "${appName}")
                echo "Found 1 ${bc.count()} buildconfig"
                def blds = bc.related('builds')
                blds.untilEach {
                  return it.object().status.phase == "Complete"
                }
              }
            }  
          }
        }
        stage("Deploy") {
          openshift.withCluster() {
            openshift.withProject() {
              def dc = openshift.selector('dc', "${appName}")
              dc.rollout().status()
            }
          }
        }
      }
   }
} catch (err) {
   echo "in catch block"
   echo "Caught: ${err}"
   currentBuild.result = 'FAILURE'
   throw err
}
